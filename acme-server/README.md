# In-Memory ACME Server

This is a simple, in-memory ACME server for testing purposes. It is written in Go and is intended to be used in integration tests where a real ACME server is not available or practical.

## Building

To build the server, run the following command:

```
go build
```

## Running

To run the server, use the following command:

```
./acme-server [flags]
```

### Flags

The following command-line flags are available:

*   `-addr`: The address to listen on (default: `:443`)
*   `-public-name`: The public DNS name of this service (default: `acme-v02.api.letsencrypt.org`)
*   `-cert-file`: The file where the root certificate should be written (default: `root-ca.pem`)
*   `-ready`: Exit successfully if cert-file exists. This is useful for checking if the server is ready to accept connections.

## Usage

This server is intended to be used in integration tests. It can be started before the tests run and stopped after the tests complete. The `-ready` flag can be used to check if the server is ready to accept connections before running the tests.

## Usage with Docker Compose

This server can be used with `docker compose`. The following is an example of how to configure the server in a `docker-compose.yaml` file:

```yaml
services:
  acme-server:
    image: c2fmzq/acme-server:integrationtest
    user: "1000:1000"
    hostname: acme-v02.api.letsencrypt.org
    command: "--cert-file=/etc/ssl/certs/root-ca.pem"
    volumes:
      - tls:/etc/ssl/certs
    healthcheck:
      test: ["CMD", "/acme-server", "--ready", "--cert-file=/etc/ssl/certs/root-ca.pem"]
      interval: 5s
      retries: 5
      start_period: 1s
```

In this example, the `acme-server` service is configured to use the `c2fmzq/acme-server:integrationtest` image. The `hostname` is set to `acme-v02.api.letsencrypt.org`, and the `--cert-file` flag is set to `/etc/ssl/certs/root-ca.pem`. A volume named `tls` is mounted at `/etc/ssl/certs` to persist the root certificate.

The `healthcheck` ensures that the server is ready to accept connections before other services that depend on it are started.

Other services can mount the `tls` volume to automatically trust the root certificate generated by the `acme-server`. The following is an example of another service mounting the `tls` volume:

```yaml
services:
  tlsproxy:
    image: c2fmzq/tlsproxy:integrationtest
    user: "1000:1000"
    hostname: tlsproxy.example.com
    command: "--passphrase=test"
    volumes:
      - tls:/etc/ssl/certs
      - ./testdata/tlsproxy-config.yaml:/config/config.yaml:ro
    depends_on:
      acme-server:
        condition: service_healthy
```

By mounting the `tls` volume at `/etc/ssl/certs`, the `tlsproxy` service will automatically trust the root certificate generated by the `acme-server`.
